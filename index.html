<!DOCTYPE html>
<html>
<head>
    <title>RS-Villa - Room s√©curis√©</title>
    <!-- Inclure Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
    <style>
        /* Styles inchang√©s... */
    </style>
</head>
<body>
    <h1>RS-Villa</h1>

    <!-- Section de connexion -->
    <div id="login-container">
        <input type="text" id="username" placeholder="Votre pseudo" required><br>
        <input type="text" id="room-name-input" placeholder="Nom de la Villa" required><br>
        <input type="password" id="password-input" placeholder="Mot de passe" required><br>
        <button onclick="joinRoom()">Entrez dans la Villa</button>
    </div>

    <!-- Section de chat -->
    <div id="chat-container">
        <div id="room-name-display" style="font-size: 1.5em; font-weight: bold; color: #ffd700; margin-bottom: 10px;"></div>

        <!-- Section pour r√©pondre √† un message -->
        <div id="reply-container">
            <span id="reply-message"></span>
            <button onclick="cancelReply()" style="float: right; background-color: #e74c3c; color: white; border: none; border-radius: 5px; padding: 5px;">Annuler</button>
        </div>

        <div id="messages"></div>
        <div id="input-section">
            <button onclick="toggleEmojiPicker()">üòä</button>
            <input type="text" id="message-input" placeholder="√âcrivez un message">
            <button onclick="sendMessage()">Envoyer</button>
            <button onclick="toggleAllMessages()">Afficher tous</button>
            <button onclick="quitRoom()">Quitter</button>
        </div>
        <div id="emoji-picker" style="display: none;">
            <!-- Emoji Picker Content -->
        </div>
    </div>

    <!-- Bouton Plier/D√©plier -->
    <button id="toggle-button" onclick="toggleInterface()">Plier</button>

    <script>
        var firebaseConfig = {
            apiKey: "AIzaSyAN7IrOQfHYJAeO49I1EZxDfupv62Ew9XI",
            authDomain: "madiko-rs.firebaseapp.com",
            databaseURL: "https://madiko-rs-default-rtdb.firebaseio.com",
            projectId: "madiko-rs",
            storageBucket: "madiko-rs.appspot.com",
            messagingSenderId: "746083664475",
            appId: "1:746083664475:web:fe2d5628d20e385d06b57e",
            measurementId: "G-EBWFWCMWFT"
        };
        firebase.initializeApp(firebaseConfig);

        var db, username, roomName, replyMessageId = null, replyMessageText = "", allMessagesVisible = false;
        var newMessageCount = 0, interfacePliee = false;

        // Fonction pour joindre la room
        function joinRoom() {
            username = document.getElementById("username").value;
            roomName = document.getElementById("room-name-input").value;
            var password = document.getElementById("password-input").value;

            db = firebase.database().ref("rooms/" + roomName);

            db.once('value').then(function(snapshot) {
                if (snapshot.exists()) {
                    var dbPassword = snapshot.child("password").val();
                    if (dbPassword === password) {
                        alert("Connexion r√©ussie !");
                        document.getElementById("room-name-display").textContent = "Villa : " + roomName;
                        switchToChat();
                    } else {
                        alert("Mot de passe incorrect !");
                    }
                } else {
                    db.set({
                        password: password,
                        messages: {}
                    }).then(() => {
                        alert("Room cr√©√© avec succ√®s !");
                        document.getElementById("room-name-display").textContent = "Villa : " + roomName;
                        switchToChat();
                    });
                }
            });
        }

        // Fonction pour basculer vers l'interface de chat
        function switchToChat() {
            document.getElementById("login-container").style.display = "none";
            document.getElementById("chat-container").style.display = "block";
            loadMessages();
            resetInactivityTimer();
        }

        function loadMessages() {
            db.child('messages').on('child_added', function(snapshot) {
                displayMessage(snapshot.key, snapshot.val());

                // Mise √† jour du compteur de nouveaux messages si l'interface est pli√©e
                if (interfacePliee && snapshot.val().user !== username) {
                    newMessageCount++;
                    updateNotificationCount();
                }
            });

            db.child('messages').on('child_removed', function(snapshot) {
                const removedMessage = document.getElementById(snapshot.key);
                if (removedMessage) removedMessage.remove();
            });
        }

        function displayMessage(key, data) {
            var msgDiv = document.createElement("div");
            msgDiv.id = key;
            msgDiv.className = (data.user === username ? "message user1" : "message user2");

            var usernameDiv = document.createElement("div");
            usernameDiv.className = "username " + (data.user === username ? "user1" : "user2");
            usernameDiv.textContent = data.user;

            var textSpan = document.createElement("span");
            textSpan.className = "msg-text flou";
            textSpan.textContent = data.message;

            var timeDiv = document.createElement("div");
            timeDiv.className = "timestamp";
            timeDiv.style.fontSize = "0.8rem";
            timeDiv.style.color = "#ccc";
            timeDiv.style.position = "absolute";
            timeDiv.style.top = "5px";
            timeDiv.style.right = "10px";
            timeDiv.textContent = data.timestamp;

            msgDiv.appendChild(usernameDiv);
            msgDiv.appendChild(timeDiv);
            msgDiv.appendChild(textSpan);

            var reactionContainer = document.createElement("div");
            reactionContainer.className = "reaction-container";
            msgDiv.appendChild(reactionContainer);

            db.child("messages/" + key + "/reactions").on("value", function(snapshot) {
                reactionContainer.innerHTML = "";
                if (snapshot.exists()) {
                    var reactionLabel = document.createElement("span");
                    reactionLabel.className = "reaction-label";
                    reactionLabel.textContent = "R√©action : ";
                    reactionContainer.appendChild(reactionLabel);
                    snapshot.forEach(function(childSnapshot) {
                        const reactionEmoji = document.createElement("span");
                        reactionEmoji.className = "reaction-emoji";
                        reactionEmoji.textContent = childSnapshot.val();
                        reactionContainer.appendChild(reactionEmoji);
                    });
                }
            });

            document.getElementById("messages").appendChild(msgDiv);
            setTimeout(function() { textSpan.classList.add("flou"); }, 15000);
            scrollToBottom();

            if (data.user !== username && document.visibilityState === 'hidden') {
                document.title = `üí¨ (${newMessageCount}) Nouveau(x) message(s)!`;
            }
        }

        // Gestion du compteur de messages non lus dans le titre
        document.addEventListener('visibilitychange', function () {
            if (document.visibilityState === 'visible') {
                document.title = 'RS-Villa - Room s√©curis√©';
                newMessageCount = 0;
            }
        });

        // Gestion de l'interface repliable
        function toggleInterface() {
            const chatContainer = document.getElementById("chat-container");
            const toggleButton = document.getElementById("toggle-button");
            chatContainer.style.display = interfacePliee ? "block" : "none";
            toggleButton.textContent = interfacePliee ? "Plier" : `D√©plier (${newMessageCount})`;
            interfacePliee = !interfacePliee;
        }

        function updateNotificationCount() {
            const toggleButton = document.getElementById("toggle-button");
            toggleButton.textContent = interfacePliee && newMessageCount > 0 ? `D√©plier (${newMessageCount})` : "D√©plier";
        }

        // Gestion de l'inactivit√©
        let inactivityTimer;
        function resetInactivityTimer() {
            clearTimeout(inactivityTimer);
            inactivityTimer = setTimeout(toggleInterface, 30000);
        }

        document.addEventListener("mousemove", resetInactivityTimer);
        document.addEventListener("keydown", resetInactivityTimer);
    </script>

    <footer style="margin-top: 20px; font-size: 0.8rem; color: #999; text-align: center;">
        &copy; RoberiX 2024
    </footer>
</body>
</html>
