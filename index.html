<!DOCTYPE html>
<html>
<head>
    <title>RS-Villa - Room sécurisé</title>
    <!-- Inclure Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
    <style>
        /* Styles précédemment définis... */
    </style>
</head>
<body>
    <h1>RS-Villa</h1>

    <!-- Section de connexion -->
    <div id="login-container">
        <input type="text" id="username" placeholder="Votre pseudo" required><br>
        <input type="text" id="room-name-input" placeholder="Nom de la Villa" required><br>
        <input type="password" id="password-input" placeholder="Mot de passe" required><br>
        <button onclick="joinRoom()">Entrez dans la Villa</button>
    </div>

    <!-- Section de chat -->
    <div id="chat-container">
        <div id="room-name-display" style="font-size: 1.2em; font-weight: bold; color: #ffd700; margin-bottom: 10px;"></div>
        <div id="messages"></div>
        <div id="input-section">
            <input type="text" id="message-input" placeholder="Ecrivez un message">
            <button onclick="sendMessage()">Envoyer</button>
            <button id="clear-btn" onclick="clearChat()">Effacer</button>
            <button id="quit-btn" onclick="quitRoom()">Quitter</button>
        </div>
    </div>

<script>
    // Configuration Firebase
    var firebaseConfig = {
        apiKey: "AIzaSyAN7IrOQfHYJAeO49I1EZxDfupv62Ew9XI",
        authDomain: "madiko-rs.firebaseapp.com",
        databaseURL: "https://madiko-rs-default-rtdb.firebaseio.com",
        projectId: "madiko-rs",
        storageBucket: "madiko-rs.appspot.com",
        messagingSenderId: "746083664475",
        appId: "1:746083664475:web:fe2d5628d20e385d06b57e",
        measurementId: "G-EBWFWCMWFT"
    };
    firebase.initializeApp(firebaseConfig);

    var db;
    var username;

    function joinRoom() {
        username = document.getElementById("username").value;
        var roomName = document.getElementById("room-name-input").value;
        var password = document.getElementById("password-input").value;

        db = firebase.database().ref("rooms/" + roomName);

        db.child("password").once('value').then(function(snapshot) {
            var dbPassword = snapshot.val();
            
            if (dbPassword === null) {
                db.set({
                    password: password,
                    messages: {}
                });
                alert("Room créé avec succès !");
                document.getElementById("room-name-display").textContent = "Villa : " + roomName;
                switchToChat();
            } else if (dbPassword === password) {
                alert("Connexion réussie !");
                document.getElementById("room-name-display").textContent = "Villa : " + roomName;
                switchToChat();
            } else {
                alert("Mot de passe incorrect !");
            }
        });
    }

    function switchToChat() {
        document.getElementById("login-container").style.display = "none";
        document.getElementById("chat-container").style.display = "block";
        loadMessages();
    }

    function sendMessage() {
        var messageInput = document.getElementById("message-input");
        var message = messageInput.value;
        if (message.trim() !== "") { // Ne pas envoyer de message vide
            db.child("messages").push().set({ "user": username, "message": message });
            messageInput.value = '';
        }
    }

    function loadMessages() {
        db.child("messages").on("child_added", function(snapshot) {
            displayMessage(snapshot.key, snapshot.val());
        });

        db.child("messages").on("child_changed", function(snapshot) {
            var msgDiv = document.getElementById(snapshot.key);
            if (msgDiv) {
                msgDiv.querySelector(".msg-text").textContent = username + ": " + snapshot.val().message;
            }
        });

        db.child("messages").on("child_removed", function(snapshot) {
            var msgDiv = document.getElementById(snapshot.key);
            if (msgDiv) {
                msgDiv.remove();
            }
        });
    }

    function displayMessage(key, data) {
        var msgDiv = document.createElement("div");
        msgDiv.id = key;
        msgDiv.className = (data.user === username ? "message user1" : "message user2");

        var textSpan = document.createElement("span");
        textSpan.className = "msg-text";
        textSpan.textContent = data.user + ": " + data.message;

        msgDiv.appendChild(textSpan);

        if (data.user === username) {
            var deleteBtn = document.createElement("button");
            deleteBtn.textContent = "Supprimer";
            deleteBtn.onclick = function() {
                db.child("messages/" + key).remove();
            };

            msgDiv.appendChild(deleteBtn);
        }

        // Ajouter le bouton "Afficher" pour flouter/déflouter le message
        var toggleBtn = document.createElement("button");
        toggleBtn.textContent = "Afficher";
        toggleBtn.onclick = function() {
            if (msgDiv.classList.contains("blurred")) {
                msgDiv.classList.remove("blurred");
                toggleBtn.textContent = "Masquer";
            } else {
                msgDiv.classList.add("blurred");
                toggleBtn.textContent = "Afficher";
            }
        };
        msgDiv.appendChild(toggleBtn);

        document.getElementById("messages").appendChild(msgDiv);
    }

    function quitRoom() {
        // Envoie une notification à l'autre utilisateur
        db.child("messages").push().set({ "user": username, "message": username + " a quitté la Villa." });
        // Déconnexion de la room
        db.off();
        document.getElementById("chat-container").style.display = "none";
        document.getElementById("login-container").style.display = "block";
        alert("Vous avez quitté la Villa.");
    }

    function clearChat() {
        db.child("messages").remove();
        document.getElementById("messages").innerHTML = '';
    }

    document.getElementById("message-input").addEventListener("keypress", function(event) {
        if (event.key === "Enter") {
            event.preventDefault();
            sendMessage();
        }
    });
</script>
    <footer style="margin-top: 20px; font-size: 0.8rem; color: #999; text-align: center;">
    &copy; RoberixPro 2024
</footer>
</body>
</html>
